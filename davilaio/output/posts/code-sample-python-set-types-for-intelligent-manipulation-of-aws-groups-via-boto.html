<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
    <head>
    <meta charset="utf-8">
    <meta name="description" content="This goes over a sample use-case of using Set in Python to make boto code more efficient.">
    <meta name="viewport" content="width=device-width">
    <title>Code Sample: Python Set Types For Intelligent Manipulation of AWS Groups via Boto | Davila.io Blog</title>

                <link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">

                    <link rel="alternate" type="application/rss+xml" title="RSS (en)" href="../rss.xml">
                <link rel="alternate" type="application/rss+xml" title="RSS (es)" href="../es/rss.xml">

      <link rel="canonical" href="http://blog.davila.io/posts/code-sample-python-set-types-for-intelligent-manipulation-of-aws-groups-via-boto.html">



    
        <!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]-->

    

    
    <meta name="author" content="Jonathan I. Davila">
        <meta property="og:site_name" content="Davila.io Blog">
    <meta property="og:title" content="Code Sample: Python Set Types For Intelligent Manipulation of AWS Grou">
    <meta property="og:url" content="http://blog.davila.io/posts/code-sample-python-set-types-for-intelligent-manipulation-of-aws-groups-via-boto.html">
    <meta property="og:description" content="This goes over a sample use-case of using Set in Python to make boto code more efficient.">
    <meta property="og:image" content="http://blog.davila.io/posts/images/venn_diagram.jpg">
    <meta property="og:type" content="article">
    <meta property="article:published_time" content="2015-03-03T08:00:00-04:00">
           <meta property="article:tag" content="aws">
           <meta property="article:tag" content="boto">
           <meta property="article:tag" content="how-to">
           <meta property="article:tag" content="python">

    
    

	<link rel="apple-touch-icon" sizes="57x57" href="../apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="../apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="../apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="../apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="../apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="../apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="../apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="../apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="../apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="../android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
	<link rel="manifest" href="../manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">
</head>
<body>
    <section class="social">
        <ul>
                    <li><a href="../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="https://linkedin.com/in/davilaio" title="My LinkedIn"><i class="icon-linkedin"></i></a></li>
            <li><a href="https://twitter.com/defionscode" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/defionscode" title="My Github"><i class="icon-github"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>

        </ul>
    </section>
    <section class="page-content">
        <div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">Code Sample: Python Set Types For Intelligent Manipulation of AWS Groups via Boto</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2015-03-03T08:00:00-04:00">2015-03-03 08:00</time>
            
                      |  
        <a href="code-sample-python-set-types-for-intelligent-manipulation-of-aws-groups-via-boto.md" id="sourcelink">Source</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../categories/aws.html" rel="tag">aws</a></li>
           <li><a class="tag p-category" href="../categories/boto.html" rel="tag">boto</a></li>
           <li><a class="tag p-category" href="../categories/how-to.html" rel="tag">how-to</a></li>
           <li><a class="tag p-category" href="../categories/python.html" rel="tag">python</a></li>
        </ul>
        </div>

        </div>
        <div class="body">
            <div>
<p><img alt="combinatronics" src="../venn_diagram.jpg">
</p>
<p>A current project of mine is the development of the Ansible AWS IAM modules for Ansible. Part of the functionality is the creation of IAM resources such as users, groups and roles. In this post I want to talk about IAM groups assigned to a given user within AWS.
<!-- TEASER_END -->
As you are aware, Ansible strives to be as idempotent as possible by only acting upon given tasks only if necessary to achieve a desired state. Most modules follow this design pattern, others (like the raw module) can’t be expected to do so.</p>
<p>While developing the first part of the IAM module, I came across a small challenge. An Ansible user would call the IAM module like this:</p>
<pre class="code literal-block"><span class="l-Scalar-Plain">iam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">iam_type=user name=SomeGuy state=present groups=devs,ops,billing</span>
</pre>


<p>This should be relatively straightforward to understand. The slight challenge was with groups. What would be the best way to check if the list of groups passed was actually the current set of groups presently assigned to the user and then how to remediate any discrepancies?</p>
<p>My initial solution was very brute, simply remove the user from ALL groups then add each group passed into the module via a loop. While aggressive, it worked. The problem was that by going about it this way, it was inefficient and made it hard to really place any logic into the module for detecting true change (or lack thereof).</p>
<p>The solution was <a href="https://docs.python.org/2/library/stdtypes.html#set">Set Types</a>. Within my code, it looks like:</p>
<pre class="code literal-block"><span class="k">try</span><span class="p">:</span>
    <span class="n">orig_users_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">og</span><span class="p">[</span><span class="s">'group_name'</span><span class="p">]</span> <span class="k">for</span> <span class="n">og</span> <span class="ow">in</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_groups_for_user</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">list_groups_for_user_result</span><span class="o">.</span><span class="n">groups</span><span class="p">]</span>
    <span class="n">remove_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">rg</span> <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">orig_users_groups</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">groups</span><span class="p">)]</span>
    <span class="n">new_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">ng</span> <span class="k">for</span> <span class="n">ng</span> <span class="ow">in</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">orig_users_groups</span><span class="p">)]</span>
<span class="k">except</span> <span class="n">boto</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">BotoServerError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="n">changed</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_users_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">new_groups</span><span class="p">:</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">add_user_to_group</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rm</span> <span class="ow">in</span> <span class="n">remove_groups</span><span class="p">:</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">remove_user_from_group</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre>


<p>In the above, ‘groups’ represents the list of groups passed in as an argument to the module which declares which groups the user should belong to.</p>
<p>Step by step, this is what happens:</p>
<ul>
<li>Create a list of all the groups the given user is currently in</li>
<li>frozenset(groups).difference(orig_users_groups) to get all the groups the user belongs to but shouldn’t belong to because they were not passed in to the groups argument.</li>
<li>The inverse of that is done to get all the groups the user is not a part off but are included in the list of groups passed into the module.</li>
<li>Then it takes into account whether or not the user was part of a group to begin with, and if so, then it adds and removes the proper groups….gracefully.</li>
</ul>
<p>And that’s it! If you’d like to see the entirety of that code, it is available <a href="https://github.com/defionscode/ansible-iam-module/blob/master/iam.py">here</a>.</p>
</div>
        </div>
                <ul class="pager">
            <li class="previous">
                <a href="how-to-interactive-vote-driven-presentations-with-revealjs-twilio-and-redis.html" rel="prev" title="How-to: Interactive Vote-Driven Presentations with Reveal.js, Twilio, and Redis">Previous post</a>
            </li>
            <li class="next">
                <a href="moving-from-wordpresscom-to-nikola.html" rel="next" title="Moving from Wordpress.com to Nikola">Next post</a>
            </li>
        </ul>

                            <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="davilaio",
            disqus_url="http://blog.davila.io/posts/code-sample-python-set-types-for-intelligent-manipulation-of-aws-groups-via-boto.html",
        disqus_title="Code Sample: Python Set Types For Intelligent Manipulation of AWS Groups via Boto",
        disqus_identifier="cache/posts/code-sample-python-set-types-for-intelligent-manipulation-of-aws-groups-via-boto.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        
    </div>
                    <footer id="footer" role="contentinfo">
            <p>Contents © 2015         <a href="mailto:jonathan@davila.io">Jonathan I. Davila</a> under <a href="../LICENSE"> GPLv2</a></p>
            
        </footer>

        </div>
    </section>
    
    
                <script src="../assets/js/all-nocdn.js" type="text/javascript"></script>
    
<!-- Social buttons -->
<div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script>
<!-- End of social buttons -->


        <script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
