<p><img alt="combinatronics" src="../venn_diagram.jpg" />
</div></p>
<p>A current project of mine is the development of the Ansible AWS IAM modules for Ansible. Part of the functionality is the creation of IAM resources such as users, groups and roles. In this post I want to talk about IAM groups assigned to a given user within AWS.
<!-- TEASER_END -->
As you are aware, Ansible strives to be as idempotent as possible by only acting upon given tasks only if necessary to achieve a desired state. Most modules follow this design pattern, others (like the raw module) can’t be expected to do so.</p>
<p>While developing the first part of the IAM module, I came across a small challenge. An Ansible user would call the IAM module like this:</p>
<pre class="code literal-block"><span class="l-Scalar-Plain">iam</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">iam_type=user name=SomeGuy state=present groups=devs,ops,billing</span>
</pre>


<p>This should be relatively straightforward to understand. The slight challenge was with groups. What would be the best way to check if the list of groups passed was actually the current set of groups presently assigned to the user and then how to remediate any discrepancies?</p>
<p>My initial solution was very brute, simply remove the user from ALL groups then add each group passed into the module via a loop. While aggressive, it worked. The problem was that by going about it this way, it was inefficient and made it hard to really place any logic into the module for detecting true change (or lack thereof).</p>
<p>The solution was <a href="https://docs.python.org/2/library/stdtypes.html#set">Set Types</a>. Within my code, it looks like:</p>
<pre class="code literal-block"><span class="k">try</span><span class="p">:</span>
    <span class="n">orig_users_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">og</span><span class="p">[</span><span class="s">&#39;group_name&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">og</span> <span class="ow">in</span> <span class="n">iam</span><span class="o">.</span><span class="n">get_groups_for_user</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">list_groups_for_user_result</span><span class="o">.</span><span class="n">groups</span><span class="p">]</span>
    <span class="n">remove_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">rg</span> <span class="k">for</span> <span class="n">rg</span> <span class="ow">in</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">orig_users_groups</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">groups</span><span class="p">)]</span>
    <span class="n">new_groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">ng</span> <span class="k">for</span> <span class="n">ng</span> <span class="ow">in</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">orig_users_groups</span><span class="p">)]</span>
<span class="k">except</span> <span class="n">boto</span><span class="o">.</span><span class="n">exception</span><span class="o">.</span><span class="n">BotoServerError</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
    <span class="n">module</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">changed</span><span class="o">=</span><span class="n">changed</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">orig_users_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">new</span> <span class="ow">in</span> <span class="n">new_groups</span><span class="p">:</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">add_user_to_group</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rm</span> <span class="ow">in</span> <span class="n">remove_groups</span><span class="p">:</span>
            <span class="n">iam</span><span class="o">.</span><span class="n">remove_user_from_group</span><span class="p">(</span><span class="n">rm</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</pre>


<p>In the above, ‘groups’ represents the list of groups passed in as an argument to the module which declares which groups the user should belong to.</p>
<p>Step by step, this is what happens:</p>
<ul>
<li>Create a list of all the groups the given user is currently in</li>
<li>frozenset(groups).difference(orig_users_groups) to get all the groups the user belongs to but shouldn’t belong to because they were not passed in to the groups argument.</li>
<li>The inverse of that is done to get all the groups the user is not a part off but are included in the list of groups passed into the module.</li>
<li>Then it takes into account whether or not the user was part of a group to begin with, and if so, then it adds and removes the proper groups….gracefully.</li>
</ul>
<p>And that’s it! If you’d like to see the entirety of that code, it is available <a href="https://github.com/defionscode/ansible-iam-module/blob/master/iam.py">here</a>.</p>